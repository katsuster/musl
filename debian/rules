#!/usr/bin/make -f

%:
	PATH=$(PREFIX)/bin:$(PATH) \
	    dh $@

build_dir = build
PREFIX = /opt/riscv

PWD := $(shell pwd)
PKGVER := $(shell head -1 PKGVERSION)

PACKAGE = riscv64-linux-musl
TARGET  = riscv64-unknown-linux-musl

MARCH_LIST = rv64gc rv64imac rv32gc rv32imac
MABI_LIST  = lp64d lp64 ilp32d ilp32
MLIB_LIST  = lib64 lib64 lib32 lib32
MFLT_LIST  = -D__riscv_hard_float -D__riscv_soft_float -D__riscv_hard_float -D__riscv_soft_float
MARCH_EXT  =

define configure_macro
	$(eval MARCH = $(word $(1),$(MARCH_LIST))$(MARCH_EXT))
	$(eval MABI  = $(word $(1),$(MABI_LIST)))
	$(eval MLIB  = $(word $(1),$(MLIB_LIST)))
	$(eval MFLT  = $(word $(1),$(MFLT_LIST)))
	$(eval SDIR  = $(PWD)/debian/$(PACKAGE)/$(PREFIX)/$(TARGET))
	mkdir -p $(build_dir)_$(MARCH)_$(PACKAGE) && \
	cd $(build_dir)_$(MARCH)_$(PACKAGE) && \
	../configure \
	  --target=$(TARGET) \
	  --prefix=$(SDIR)/usr \
	  --enable-shared \
	  --libdir=$(SDIR)/usr/$(MLIB)/$(MABI) \
	  CPPFLAGS="$(MFLT)" \
	  CFLAGS="-O2 -mcmodel=medany -march=$(MARCH) -mabi=$(MABI)"
endef

define build_macro
	$(eval MARCH = $(word $(1),$(MARCH_LIST))$(MARCH_EXT))
	dh_auto_build -B$(build_dir)_$(MARCH)_$(PACKAGE) --parallel
endef

define install_macro
	$(eval MARCH = $(word $(1),$(MARCH_LIST))$(MARCH_EXT))
	$(eval SDIR  = $(PWD)/debian/$(PACKAGE)/$(PREFIX)/$(TARGET))
	$(MAKE) -C $(build_dir)_$(MARCH)_$(PACKAGE) install
endef

define shlibdeps_macro
	$(eval MABI  = $(word $(1),$(MABI_LIST)))
	$(eval MLIB  = $(word $(1),$(MLIB_LIST)))
	$(eval SDIR  = $(PWD)/debian/$(PACKAGE)/$(PREFIX)/$(TARGET))
	###dh_shlibdeps -l$(SDIR)/lib:$(SDIR)/$(MLIB)/$(MABI)
endef

override_dh_auto_clean:

override_dh_autoreconf:

override_dh_auto_configure:
	$(call configure_macro,1)
	$(call configure_macro,2)

override_dh_auto_build:
	$(call build_macro,1)
	$(call build_macro,2)

# Ignore tests
override_dh_auto_test:

override_dh_auto_install:
	$(call install_macro,1)
	$(call install_macro,2)

# Ignore strip
override_dh_strip:

override_dh_shlibdeps:
	$(call shlibdeps_macro,1)
	$(call shlibdeps_macro,2)
